apiVersion: apps/v1
kind: Deployment
metadata:
  name: hytale-deployment
  labels:
    app: hytale
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hytale
  template:
    metadata:
      labels:
        app: hytale
    spec:
      # ------------------------------------------------------------------
      # 1. Give the pod a non‑root UID/GID and ensure the PVC gets that group
      # ------------------------------------------------------------------
      securityContext:
        # All volumes mounted into this pod will get group 1000 (or whatever
        # UID/GID your image uses for the “container” user).
        fsGroup: 1000

      # ------------------------------------------------------------------
      # 2. Init‑container that runs as root and fixes ownership
      # ------------------------------------------------------------------
      initContainers:
      - name: init-chown
        image: busybox:latest
        command:
          - sh
          - -c
          - |
            chown -R 1000:1000 /home/container
            chmod -R 770 /home/container
        volumeMounts:
        - name: hytale-data
          mountPath: /home/container
      # ------------------------------------------------------------------
      # 3. Main container
      # ------------------------------------------------------------------
      containers:
      - name: hytale-server
        image: deinfreu/hytale-server:experimental
        stdin: true
        tty: true
        securityContext:
          # Run as the same UID/GID that we gave the PVC in the init‑container.
          runAsUser: 1000
          runAsGroup: 1000
          # No privilege escalation – this satisfies Kyverno’s root‑deny.
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false   # you already had this
        env:
        # ---- Core Server Settings ----
        - name: SERVER_IP
          value: "0.0.0.0"
        - name: SERVER_PORT
          value: "5520"
        - name: PROD
          value: "FALSE"
        - name: DEBUG
          value: "FALSE"
        - name: TZ
          value: "Europe/Amsterdam"
        - name: JAVA_ARGS
          value: ""

        # ---- Hytale Server Options ----
        - name: HYTALE_CACHE
          value: "FALSE"
        - name: HYTALE_CACHE_DIR
          value: "./Server/HytaleServer.aot"
        - name: HYTALE_ACCEPT_EARLY_PLUGINS
          value: "FALSE"
        - name: HYTALE_ALLOW_OP
          value: "FALSE"
        - name: HYTALE_AUTH_MODE
          value: ""
        - name: HYTALE_BACKUP
          value: "FALSE"
        - name: HYTALE_BACKUP_DIR
          value: "./backups"
        - name: HYTALE_BACKUP_FREQUENCY
          value: ""
        - name: HYTALE_BACKUP_MAX_COUNT
          value: ""
        - name: HYTALE_BARE
          value: "FALSE"
        - name: HYTALE_BOOT_COMMAND
          value: ""
        - name: HYTALE_CLIENT_PID
          value: ""
        - name: HYTALE_DISABLE_ASSET_COMPARE
          value: "FALSE"
        - name: HYTALE_DISABLE_CPB_BUILD
          value: "FALSE"
        - name: HYTALE_DISABLE_FILE_WATCHER
          value: "FALSE"
        - name: HYTALE_DISABLE_SENTRY
          value: "FALSE"
        - name: HYTALE_EARLY_PLUGINS
          value: ""
        - name: HYTALE_EVENT_DEBUG
          value: "FALSE"
        - name: HYTALE_FORCE_NETWORK_FLUSH
          value: "true"
        - name: HYTALE_GENERATE_SCHEMA
          value: "FALSE"
        - name: HYTALE_IDENTITY_TOKEN
          value: ""
        - name: HYTALE_LOG
          value: ""
        - name: HYTALE_MIGRATE_WORLDS
          value: ""
        - name: HYTALE_MIGRATIONS
          value: ""
        - name: HYTALE_MODS
          value: ""
        - name: HYTALE_OWNER_NAME
          value: "McKensy"
        - name: HYTALE_OWNER_UUID
          value: "73d978ab-91be-487d-a472-691ded59f158"
        - name: HYTALE_PREFAB_CACHE
          value: ""
        - name: HYTALE_SESSION_TOKEN
          value: ""
        - name: HYTALE_SHUTDOWN_AFTER_VALIDATE
          value: "FALSE"
        - name: HYTALE_SINGLEPLAYER
          value: "FALSE"
        - name: HYTALE_TRANSPORT
          value: ""
        - name: HYTALE_UNIVERSE
          value: ""
        - name: HYTALE_VALIDATE_ASSETS
          value: "FALSE"
        - name: HYTALE_VALIDATE_PREFABS
          value: ""
        - name: HYTALE_VALIDATE_WORLD_GEN
          value: "FALSE"
        - name: HYTALE_VERSION
          value: "FALSE"
        - name: HYTALE_WORLD_GEN
          value: ""

        # ---- Hytale Settings (config.json) ----
        - name: HYTALE_SERVER_NAME
          value: "McK's Hytale Server"
        - name: HYTALE_MOTD
          value: "currently testing for stability and performance."
        - name: HYTALE_PASSWORD
          value: "meep"
        - name: HYTALE_MAX_PLAYERS
          value: "10"
        - name: HYTALE_MAX_VIEW_RADIUS
          value: "32"
        - name: HYTALE_COMPRESSION
          value: "false"
        - name: HYTALE_WORLD
          value: "default"
        - name: HYTALE_GAMEMODE
          value: "Adventure"
        ports:
        - containerPort: 5520  # The port the container listens on
          protocol: UDP
        volumeMounts:
        - name: hytale-data
          mountPath: /home/container
        - name: machine-id
          mountPath: /etc/machine-id
          subPath: machine-id
          readOnly: true
      volumes:
      - name: machine-id
        configMap:
          name: machine-id
          items:
          - key: machine-id
            path: machine-id
      - name: hytale-data
        persistentVolumeClaim:
          claimName: hytale-datadir